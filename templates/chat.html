<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Codex Chat Monitor</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0d10; color: #e6edf3; }
      header { padding: 12px 16px; background: #11161c; border-bottom: 1px solid #1f2937; display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
      select, button, input[type=text], input[type=range] { background:#0f172a; color:#e6edf3; border:1px solid #334155; padding:6px 8px; border-radius:6px; }
      button:hover { background:#111827; cursor:pointer; }
      #stats { margin-left:auto; font-size:12px; opacity:.8 }
      #chat { padding: 12px 16px; height: calc(100vh - 116px); overflow-y: auto; box-sizing: border-box; }
      #compose { display:flex; gap:8px; align-items:center; padding: 8px 16px 12px; border-top: 1px solid #1f2937; background:#0b0d10; position: sticky; bottom: 0; }
      #msgBox { flex: 1; }
      .msg { max-width: 70%; margin: 8px 0; padding: 8px 10px; border-radius: 10px; line-height: 1.3; white-space: pre-wrap; }
      .msg.user { background: #1f2937; border-top-left-radius: 4px; }
      .msg.ai { background: #0d3b66; border-top-left-radius: 4px; }
      .meta { font-size: 11px; opacity: 0.75; margin-bottom: 4px; }
      .right { margin-left: auto; text-align: right; }
      .left  { margin-right: auto; text-align: left; }
      .row { display:flex; flex-direction: column; }
    </style>
  </head>
  <body>
    <header>
      <strong>Codex Chat Monitor</strong>
      <label for="sessionSel" style="margin-left:8px">Session:</label>
      <select id="sessionSel"></select>
      <button id="loadBtn">Load</button>
      <button id="newBtn">New</button>
      <button id="refreshBtn">Refresh</button>
      <span id="stats"></span>
    </header>
    <div id="chat"></div>
    <div id="compose">
      <label for="fromId">From:</label>
      <input id="fromId" type="text" placeholder="sender id (e.g., brent)" value="brent" style="width:140px" />
      <input id="msgBox" type="text" placeholder="Type a message." />
      <label style="display:flex; align-items:center; gap:6px; font-size:12px; opacity:.9"> <input id="autoReply" type="checkbox" checked /> Ask Codex to reply</label>
      
      <label style="display:flex; align-items:center; gap:6px; font-size:12px; opacity:.9"> Last <span id="limitLabel">100</span> <input id="limitRange" type="range" min="10" max="500" step="10" value="100" /></label>
      <button id="sendBtn">Send</button>
    </div>
    <script>
      const sel = document.getElementById('sessionSel');
      const chat = document.getElementById('chat');
      const stats = document.getElementById('stats');
      
      const limitRange = document.getElementById('limitRange');
      const limitLabel = document.getElementById('limitLabel');
      let current = null;
      let timer = null;
      let viewLimit = 100;
      let isAtBottom = true; // track if user is at (or near) bottom

      async function listSessions() {
        const r = await fetch('/sessions');
        const j = await r.json();
        sel.innerHTML = '';
        (j.sessions || []).forEach(s => {
          const o = document.createElement('option');
          o.value = s.session_id; o.textContent = `${s.session_id.slice(0,8)}. (${s.messages} msgs, ${s.token_usage} tok)`;
          sel.appendChild(o);
        });
        if (current && [...sel.options].some(o => o.value === current)) sel.value = current;
      }
      function renderMessages(items, preserveScroll=false) {
        // track scroll state for smart auto-scroll
        const prevScrollTop = chat.scrollTop;
        const prevScrollHeight = chat.scrollHeight;
        chat.innerHTML = '';
        (items || []).forEach(m => {
          const row = document.createElement('div'); row.className = 'row';
          const meta = document.createElement('div'); meta.className = 'meta left';
          meta.textContent = `${m.ai_id ? m.ai_id : (m.from === 'ai' ? 'codex' : 'user')} · ${formatTimestamp(m.ts || '')}`;
          const bubble = document.createElement('div'); bubble.className = 'msg ' + (m.from === 'ai' ? 'ai left' : 'user left'); bubble.textContent = m.content || '';
          row.appendChild(meta); row.appendChild(bubble); chat.appendChild(row);
        });
        if (preserveScroll) {
          const delta = chat.scrollHeight - prevScrollHeight;
          chat.scrollTop = prevScrollTop + Math.max(0, delta);
        } else {
          chat.scrollTop = chat.scrollHeight;
        }
        // update bottom flag after render
        isAtBottom = shouldAutoScroll();
      }

      function shouldAutoScroll() {
        const threshold = 4; // px from bottom (tighter for precision)
        return (chat.scrollTop + chat.clientHeight) >= (chat.scrollHeight - threshold);
      }

      function formatTimestamp(isoString) {
        if (!isoString) return '';
        // Normalize ISO microseconds to milliseconds for broad JS Date compatibility
        let s = String(isoString);
        s = s.replace(/\.(\d{3})\d+(?=[Z+-])/, '.$1'); // trim fractional seconds to 3 digits
        const date = new Date(s);
        if (isNaN(date.getTime())) return '';
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();
        if (isToday) {
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
          return date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
      }

      async function loadSelected() {
        const id = sel.value; if (!id) return;
        current = id;
        const atBottom = isAtBottom;
        const r = await fetch(`/sessions/${id}/messages?limit=${viewLimit}`);
        const j = await r.json();
        // preserve scroll if user is not at bottom
        renderMessages(j.messages, !atBottom);
        stats.textContent = `${j.messages.length} msgs · ${j.token_usage} tokens`;
      }

      async function createNew() {
        const r = await fetch('/sessions', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ai_ids: ['codex'] }) });
        const j = await r.json();
        current = j.session.session_id; await listSessions(); sel.value = current; await loadSelected();
      }

      document.getElementById('loadBtn').onclick = loadSelected;
      document.getElementById('newBtn').onclick = createNew;
      document.getElementById('refreshBtn').onclick = async () => { await listSessions(); await loadSelected(); };

      limitRange.addEventListener('input', () => {
        viewLimit = parseInt(limitRange.value, 10) || 100;
        limitLabel.textContent = String(viewLimit);
      });
      limitRange.addEventListener('change', loadSelected);

      async function sendMessage() {
        if (!current) { await createNew(); }
        const fromId = document.getElementById('fromId').value.trim() || 'brent';
        const box = document.getElementById('msgBox');
        const auto = document.getElementById('autoReply').checked;
        const text = box.value.trim();
        if (!text) return;
        const btn = document.getElementById('sendBtn');
        btn.disabled = true; btn.textContent = 'Sending.';
        try {
          if (auto) {
            await fetch('/chat-with-codex', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-AI-Id': fromId },
              body: JSON.stringify({ message: text, session_id: current })
            });
            await loadSelected();
          } else {
            await fetch(`/sessions/${current}/messages`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ from: 'user', content: text, ai_id: fromId })
            });
            await loadSelected();
          }
          box.value = '';
        } catch (e) {
          console.error(e);
        } finally {
          btn.disabled = false; btn.textContent = 'Send';
        }
      }

      document.getElementById('sendBtn').onclick = sendMessage;
      document.getElementById('msgBox').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      // Track user scroll position to decide auto-scroll behavior
      chat.addEventListener('scroll', () => {
        isAtBottom = shouldAutoScroll();
      });

      (async () => {
        await listSessions();
        if (sel.options.length) { sel.selectedIndex = 0; current = sel.value; await loadSelected(); }
        timer = setInterval(loadSelected, 3000);
      })();
    </script>
  </body>
  </html>
