<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Codex Chat Monitor</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        background: #0b0d10;
        color: #e6edf3;
        min-height: 100vh;
      }

      .app-shell {
        display: flex;
        min-height: 100vh;
        width: 100%;
      }

      .sidebar {
        width: 280px;
        background: #11161c;
        border-right: 1px solid #1f2937;
        padding: 20px 18px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .sidebar-title {
        font-weight: 600;
        font-size: 1.05rem;
      }

      .icon-button {
        border: none;
        background: rgba(148, 163, 184, 0.12);
        color: #cbd5f5;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .icon-button:hover {
        background: rgba(148, 163, 184, 0.2);
        transform: translateY(-1px);
      }

      .sidebar-new {
        border: none;
        background: linear-gradient(135deg, #4f46e5, #60a5fa);
        color: white;
        padding: 10px 12px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .sidebar-new:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 24px rgba(99, 102, 241, 0.35);
      }

      .session-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .session-empty {
        color: #94a3b8;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .session-item {
        border: 1px solid transparent;
        background: #0f172a;
        color: inherit;
        border-radius: 12px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        cursor: pointer;
        transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
      }

      .session-item:focus {
        outline: 2px solid rgba(99, 102, 241, 0.6);
        outline-offset: 2px;
      }

      .session-item:hover {
        background: #182540;
        transform: translateY(-1px);
      }

      .session-item.active {
        border-color: #6366f1;
        background: #1f2a44;
      }

      .session-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
        align-items: flex-start;
        flex: 1;
      }

      .session-name {
        font-weight: 600;
        font-size: 0.95rem;
      }

      .session-meta {
        font-size: 0.78rem;
        color: #9ca3af;
      }

      .session-actions {
        display: inline-flex;
        gap: 6px;
      }

      .session-action {
        border: none;
        background: rgba(148, 163, 184, 0.18);
        color: #ccd6f6;
        border-radius: 8px;
        padding: 6px 8px;
        cursor: pointer;
        font-size: 0.85rem;
        line-height: 1;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .session-action:hover {
        background: rgba(148, 163, 184, 0.28);
        transform: translateY(-1px);
      }

      .session-action.delete {
        color: #fca5a5;
        background: rgba(248, 113, 113, 0.12);
      }

      .session-action.delete:hover {
        background: rgba(248, 113, 113, 0.2);
      }

      .sidebar-footer {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .sidebar-link {
        color: #a5b4fc;
        text-decoration: none;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        opacity: 0.9;
      }

      .sidebar-link:hover {
        opacity: 1;
        text-decoration: underline;
      }

      body.sidebar-hidden .sidebar {
        display: none;
      }

      .sidebar-button {
        flex: 1;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: transparent;
        color: #cbd5f5;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease;
      }

      .sidebar-button:hover {
        background: rgba(15, 23, 42, 0.65);
        border-color: rgba(99, 102, 241, 0.5);
      }

      .sidebar-button.danger {
        color: #f87171;
        border-color: rgba(248, 113, 113, 0.4);
      }

      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .topbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        border-bottom: 1px solid #1f2937;
        background: #11161c;
        position: sticky;
        top: 0;
        z-index: 20;
      }

      .topbar h1 {
        flex: 1;
        margin: 0;
        font-size: 1.3rem;
        letter-spacing: 0.01em;
      }

      .ghost-button {
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: transparent;
        color: #cbd5f5;
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
      }

      .ghost-button:hover {
        background: rgba(148, 163, 184, 0.18);
        border-color: rgba(148, 163, 184, 0.45);
        transform: translateY(-1px);
      }

      .session-toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #1f2937;
        flex-wrap: wrap;
        background: #0b0d10;
      }

      #sessionName {
        background: #0f172a;
        color: #e6edf3;
        border: 1px solid #334155;
        padding: 6px 10px;
        border-radius: 8px;
        min-width: 220px;
        flex: 1;
      }

      #sessionName:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
      }

      .primary-button {
        border: none;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 7px 16px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .primary-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(99, 102, 241, 0.35);
      }

      .danger-button {
        border: 1px solid rgba(248, 113, 113, 0.4);
        background: rgba(248, 113, 113, 0.1);
        color: #f87171;
      }

      .danger-button:hover {
        background: rgba(248, 113, 113, 0.2);
      }

      #stats {
        font-size: 0.85rem;
        opacity: 0.75;
        margin-left: auto;
        white-space: nowrap;
      }

      #chat {
        flex: 1;
        padding: 16px 20px;
        overflow-y: auto;
        box-sizing: border-box;
      }

      #compose {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 12px 20px 16px;
        border-top: 1px solid #1f2937;
        background: #0b0d10;
        position: sticky;
        bottom: 0;
      }

      #compose label {
        font-size: 0.8rem;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      #fromId,
      #msgBox {
        background: #0f172a;
        color: inherit;
        border: 1px solid #334155;
        padding: 8px 10px;
        border-radius: 8px;
      }

      #fromId {
        width: 140px;
      }

      #fromId:focus,
      #msgBox:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
      }

      #limitRange {
        accent-color: #6366f1;
      }

      #sendBtn {
        border: none;
        background: linear-gradient(135deg, #4f46e5, #60a5fa);
        color: white;
        padding: 8px 18px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      #sendBtn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 18px rgba(99, 102, 241, 0.35);
      }

      .row {
        display: flex;
        flex-direction: column;
      }

      .msg {
        max-width: 70%;
        margin: 8px 0;
        padding: 10px 12px;
        border-radius: 10px;
        line-height: 1.4;
        white-space: pre-wrap;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18);
      }

      .msg.user {
        background: #1f2937;
        border-top-left-radius: 4px;
      }

      .msg.ai {
        background: linear-gradient(135deg, #0d3b66, #1d4f91);
        border-top-left-radius: 4px;
      }

      .msg.system {
        background: #f3e5f5;
        color: #2d0b45;
        border-left: 4px solid #9c27b0;
      }

      .msg.error {
        background: #ffebee;
        color: #5f2120;
        border-left: 4px solid #f44336;
      }

      .meta {
        font-size: 11px;
        opacity: 0.75;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .meta .timestamp {
        font-variant-numeric: tabular-nums;
      }

      .left {
        margin-right: auto;
        text-align: left;
      }

      .error-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        background: #ff5c5c;
        color: #fff;
        border-radius: 10px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.4);
        z-index: 1100;
        transform: translateX(120%);
        transition: transform 0.3s ease-in-out;
        backdrop-filter: blur(6px);
      }

      .error-notification.show {
        transform: translateX(0);
      }

      .error-notification.hidden {
        display: none;
      }

      .error-content {
        display: flex;
        padding: 16px 18px;
        align-items: flex-start;
        gap: 12px;
      }

      .error-icon {
        font-size: 26px;
        flex-shrink: 0;
      }

      .error-details {
        flex: 1;
      }

      .error-message {
        font-weight: 600;
        margin-bottom: 4px;
        letter-spacing: 0.01em;
      }

      .error-recovery {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 4px;
      }

      .error-code {
        font-size: 12px;
        opacity: 0.75;
        font-family: "JetBrains Mono", "Fira Code", monospace;
      }

      .error-dismiss {
        background: rgba(255, 255, 255, 0.14);
        border: none;
        color: inherit;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        flex-shrink: 0;
        transition: background 0.2s ease;
      }

      .error-dismiss:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .system-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(15, 23, 42, 0.85);
        color: #fff;
        padding: 8px 14px;
        border-radius: 24px;
        font-size: 13px;
        z-index: 1050;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(4px);
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #22c55e;
        animation: pulse 2s infinite;
      }

      .status-indicator.error {
        background: #ef4444;
      }

      .status-indicator.warning {
        background: #f59e0b;
      }

      .status-text {
        letter-spacing: 0.02em;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
      }

      .loading-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #9ca3af;
        font-style: italic;
      }

      .loading-dots {
        display: inline-flex;
        gap: 3px;
      }

      .loading-dots span {
        width: 6px;
        height: 6px;
        background: #9ca3af;
        border-radius: 50%;
        animation: loading-bounce 1.4s infinite ease-in-out both;
      }

      .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
      .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

      @keyframes loading-bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
      }

      @media (max-width: 1024px) {
        .app-shell {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #1f2937;
        }

        .topbar {
          position: relative;
        }
      }

      @media (max-width: 768px) {
        #compose {
          flex-wrap: wrap;
        }

        #stats {
          margin-left: 0;
        }

        .topbar h1 {
          font-size: 1.1rem;
        }

        .session-toolbar {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div id="error-notification" class="error-notification hidden">
      <div class="error-content">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-details">
          <div class="error-message"></div>
          <div class="error-recovery"></div>
          <div class="error-code"></div>
        </div>
        <button class="error-dismiss" onclick="dismissError()">√ó</button>
      </div>
    </div>
    <div id="system-status" class="system-status">
      <div class="status-indicator" id="status-indicator"></div>
      <span class="status-text" id="status-text">Connecting‚Ä¶</span>
    </div>
    <div class="app-shell">
      <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
          <span class="sidebar-title">Sessions</span>
          <button id="closeSidebar" class="icon-button" title="Hide session navigator">‚úï</button>
        </div>
        <button id="newBtn" class="sidebar-new">Ôºã New Session</button>
        <div id="sessionList" class="session-list">
          <div class="session-empty">No sessions yet. Create one to get started.</div>
        </div>
        <div class="sidebar-footer">
          <button id="refreshSessionsBtn" class="sidebar-button">Refresh List</button>
        </div>
        <a href="/" class="sidebar-link">‚¨Ö Control Center</a>
      </aside>
      <main class="main">
        <div class="topbar">
          <button id="toggleSidebar" class="icon-button" title="Toggle session navigator">‚ò∞</button>
          <h1>Codex Chat Monitor</h1>
          <a href="/" class="ghost-button">Control Center</a>
        </div>
        <div class="session-toolbar">
          <input id="sessionName" type="text" placeholder="Add a friendly session name" />
          <button id="saveNameBtn" class="primary-button">Save Name</button>
          <button id="refreshBtn" class="ghost-button">Refresh Messages</button>
          <span id="stats"></span>
        </div>
        <div id="chat"></div>
        <div id="compose">
          <label for="fromId">From:</label>
          <input id="fromId" type="text" placeholder="sender id (e.g., brent)" value="brent" />
          <input id="msgBox" type="text" placeholder="Type a message." />
          <label>
            <input id="autoReply" type="checkbox" checked />
            Ask Codex to reply
          </label>
          <label>
            Last <span id="limitLabel">100</span>
            <input id="limitRange" type="range" min="10" max="500" step="10" value="100" />
          </label>
          <button id="sendBtn">Send</button>
        </div>
      </main>
    </div>
    <script>
      const chat = document.getElementById('chat');
      const stats = document.getElementById('stats');
      const sessionNameInput = document.getElementById('sessionName');
      const saveNameBtn = document.getElementById('saveNameBtn');
      const statusIndicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const errorNotification = document.getElementById('error-notification');
      const sessionList = document.getElementById('sessionList');
      const toggleSidebarBtn = document.getElementById('toggleSidebar');
      const closeSidebarBtn = document.getElementById('closeSidebar');
      const newBtn = document.getElementById('newBtn');
      const refreshSessionsBtn = document.getElementById('refreshSessionsBtn');
      const refreshBtn = document.getElementById('refreshBtn');

      const limitRange = document.getElementById('limitRange');
      const limitLabel = document.getElementById('limitLabel');

      let current = null;
      let timer = null;
      let viewLimit = 100;
      let isAtBottom = true;
      let currentErrorTimeout = null;
      let sessionMetadata = {};
      let isEditingName = false;

      function updateSystemStatus(state, text) {
        statusIndicator.classList.remove('error', 'warning');
        if (state === 'error') {
          statusIndicator.classList.add('error');
        } else if (state === 'warning') {
          statusIndicator.classList.add('warning');
        }
        statusText.textContent = text;
      }

      function dismissError() {
        errorNotification.classList.remove('show');
        if (currentErrorTimeout) {
          clearTimeout(currentErrorTimeout);
          currentErrorTimeout = null;
        }
        setTimeout(() => {
          errorNotification.classList.add('hidden');
        }, 250);
        setTimeout(() => updateSystemStatus('connected', 'Connected'), 1500);
      }

      function showError({ title, message, recovery, code }) {
        const messageEl = errorNotification.querySelector('.error-message');
        const recoveryEl = errorNotification.querySelector('.error-recovery');
        const codeEl = errorNotification.querySelector('.error-code');

        messageEl.textContent = title || message || 'An error occurred';
        recoveryEl.textContent = recovery || '';
        codeEl.textContent = code ? `Code: ${code}` : '';

        errorNotification.classList.remove('hidden');
        requestAnimationFrame(() => errorNotification.classList.add('show'));

        if (currentErrorTimeout) {
          clearTimeout(currentErrorTimeout);
        }
        currentErrorTimeout = setTimeout(dismissError, 10000);
        updateSystemStatus('error', 'Error encountered');
      }

      function addLoadingMessage(label = 'Codex is thinking') {
        removeLoadingMessage();
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'row';
        loadingDiv.id = 'loading-row';
        loadingDiv.innerHTML = `
          <div class="meta left"><span class="timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></div>
          <div class="msg system loading-message">
            <div class="loading-indicator">
              <span>${label}</span>
              <div class="loading-dots"><span></span><span></span><span></span></div>
            </div>
          </div>
        `;
        chat.appendChild(loadingDiv);
        chat.scrollTop = chat.scrollHeight;
        return loadingDiv;
      }

      function removeLoadingMessage() {
        const loadingRow = document.getElementById('loading-row');
        if (loadingRow) {
          loadingRow.remove();
        }
      }

      function highlightSession(sessionId) {
        sessionList.querySelectorAll('.session-item').forEach(item => {
          item.classList.toggle('active', sessionId && item.dataset.sessionId === sessionId);
        });
      }

      function renderSessionList(sessions) {
        sessionList.innerHTML = '';
        if (!sessions.length) {
          const empty = document.createElement('div');
          empty.className = 'session-empty';
          empty.textContent = 'No sessions yet. Create one to get started.';
          sessionList.appendChild(empty);
          return;
        }
        sessions.forEach(s => {
          const friendly = (s.display_name && s.display_name.trim()) || `${s.session_id.slice(0, 8)}‚Ä¶`;
          const item = document.createElement('div');
          item.className = 'session-item';
          item.dataset.sessionId = s.session_id;
          item.setAttribute('role', 'button');
          item.setAttribute('tabindex', '0');
          item.innerHTML = `
            <div class="session-info">
              <span class="session-name">${friendly}</span>
              <span class="session-meta">${s.messages} msgs ¬∑ ${s.token_usage} tok</span>
            </div>
            <div class="session-actions">
              <button type="button" class="session-action copy" title="Copy session ID">üìã</button>
              <button type="button" class="session-action delete" title="Delete session">üóë</button>
            </div>
          `;
          if (s.session_id === current) {
            item.classList.add('active');
          }
          item.addEventListener('click', () => {
            selectSession(s.session_id);
            if (window.innerWidth < 900) {
              document.body.classList.add('sidebar-hidden');
            }
          });
          item.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              selectSession(s.session_id);
              if (window.innerWidth < 900) {
                document.body.classList.add('sidebar-hidden');
              }
            }
          });
          const copyButton = item.querySelector('.session-action.copy');
          const deleteButton = item.querySelector('.session-action.delete');
          copyButton.addEventListener('click', (event) => {
            event.stopPropagation();
            copySessionId(s.session_id, copyButton);
          });
          deleteButton.addEventListener('click', (event) => {
            event.stopPropagation();
            deleteSessionById(s.session_id);
          });
          sessionList.appendChild(item);
        });
      }

      async function listSessions({ suppressErrors = false } = {}) {
        try {
          const response = await fetch('/sessions');
          if (!response.ok) {
            if (!suppressErrors) {
              const data = await response.json().catch(() => ({}));
              showError({
                title: data.message || 'Unable to load sessions',
                recovery: data.recovery || 'Refresh and try again',
                code: data.code || 'LIST_SESSIONS_ERROR'
              });
            }
            return false;
          }
          const data = await response.json();
          const sessions = data.sessions || [];
          sessionMetadata = {};
          sessions.forEach(s => { sessionMetadata[s.session_id] = s; });
          renderSessionList(sessions);
          if (current && sessionMetadata[current]) {
            selectSession(current, { load: false });
          } else if (sessions.length) {
            selectSession(sessions[0].session_id, { load: false });
          } else {
            selectSession(null, { load: false });
          }
          return true;
        } catch (e) {
          console.error('listSessions failed', e);
          if (!suppressErrors) {
            showError({ title: 'Unable to load sessions', recovery: 'Check connection and retry', code: 'LIST_SESSIONS_ERROR' });
          }
          return false;
        }
      }

      function renderMessages(items, preserveScroll = false) {
        const prevScrollTop = chat.scrollTop;
        const prevScrollHeight = chat.scrollHeight;
        chat.innerHTML = '';
        (items || []).forEach(m => {
          const row = document.createElement('div');
          row.className = 'row';
          const meta = document.createElement('div');
          meta.className = 'meta left';
          const speaker = m.ai_id ? m.ai_id : (m.from === 'ai' ? 'codex' : (m.from || 'user'));
          meta.innerHTML = `<strong>${speaker}</strong><span class="timestamp">${formatTimestamp(m.ts || '')}</span>`;
          const type = m.from === 'ai' ? 'ai' : (m.from === 'system' ? 'system' : 'user');
          const bubble = document.createElement('div');
          bubble.className = `msg ${type} left`;
          bubble.textContent = m.content || '';
          row.appendChild(meta);
          row.appendChild(bubble);
          chat.appendChild(row);
        });
        if (preserveScroll) {
          const delta = chat.scrollHeight - prevScrollHeight;
          chat.scrollTop = prevScrollTop + Math.max(0, delta);
        } else {
          chat.scrollTop = chat.scrollHeight;
        }
        isAtBottom = shouldAutoScroll();
      }

      function addMessage(sender, text, type = 'system') {
        const atBottom = shouldAutoScroll();
        const row = document.createElement('div');
        row.className = 'row';
        const meta = document.createElement('div');
        meta.className = 'meta left';
        meta.innerHTML = `<strong>${sender}</strong><span class="timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;
        const bubble = document.createElement('div');
        bubble.className = `msg ${type} left`;
        bubble.textContent = text;
        row.appendChild(meta);
        row.appendChild(bubble);
        chat.appendChild(row);
        if (atBottom) {
          chat.scrollTop = chat.scrollHeight;
        }
      }

      function shouldAutoScroll() {
        const threshold = 4;
        return (chat.scrollTop + chat.clientHeight) >= (chat.scrollHeight - threshold);
      }

      function formatTimestamp(isoString) {
        if (!isoString) return '';
        let s = String(isoString);
        s = s.replace(/\.(\d{3})\d+(?=[Z+-])/, '.$1');
        const date = new Date(s);
        if (isNaN(date.getTime())) return '';
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();
        if (isToday) {
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        return date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      }

      function selectSession(sessionId, { load = true } = {}) {
        if (!sessionId) {
          current = null;
          highlightSession(null);
          if (!isEditingName) {
            sessionNameInput.value = '';
          }
          stats.textContent = '';
          chat.innerHTML = '';
          return;
        }
        current = sessionId;
        highlightSession(sessionId);
        const meta = sessionMetadata[sessionId] || {};
        if (!isEditingName) {
          sessionNameInput.value = meta.display_name || '';
        }
        if (load) {
          loadSelected();
        }
      }

      async function loadSelected() {
        if (!current) {
          return;
        }
        const atBottom = isAtBottom;
        try {
          const response = await fetch(`/sessions/${current}/messages?limit=${viewLimit}`);
          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            showError({
              title: data.message || 'Failed to load session messages',
              recovery: data.recovery || 'Please refresh and try again',
              code: data.code,
            });
            return;
          }
          const data = await response.json();
          if (!isEditingName) {
            sessionNameInput.value = data.display_name || '';
          }
          if (!sessionMetadata[current]) {
            sessionMetadata[current] = { session_id: current };
          }
          sessionMetadata[current].display_name = data.display_name || '';
          renderMessages(data.messages, !atBottom);
          stats.textContent = `${data.messages.length} msgs ¬∑ ${data.token_usage} tokens`;
        } catch (e) {
          console.error('loadSelected failed', e);
          showError({ title: 'Unable to load messages', recovery: 'Check your connection and retry', code: 'LOAD_MESSAGES_ERROR' });
        }
      }

      async function createNew() {
        updateSystemStatus('warning', 'Creating session‚Ä¶');
        try {
          const payload = { ai_ids: ['codex'] };
          const desiredName = (sessionNameInput.value || '').trim();
          if (desiredName) {
            payload.display_name = desiredName;
          }
          const response = await fetch('/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.session) {
            showError({ title: data.message || 'Failed to create session', recovery: data.recovery || 'Try again', code: data.code });
            return;
          }
          current = data.session.session_id;
          const listed = await listSessions({ suppressErrors: true });
          if (!listed) {
            updateSystemStatus('warning', 'Session created but list unavailable');
          } else {
            selectSession(current);
          }
          isEditingName = false;
          sessionNameInput.value = data.session.display_name || desiredName || '';
          addMessage('System', `Session created: ${current}`, 'system');
          updateSystemStatus('connected', 'Connected');
        } catch (e) {
          console.error('createNew failed', e);
          showError({ title: 'Failed to create session', recovery: 'Check connection and retry', code: 'SESSION_CREATE_ERROR' });
        }
      }

      function getSessionDisplayName(sessionId) {
        const meta = sessionMetadata[sessionId] || {};
        return (meta.display_name && meta.display_name.trim()) || sessionId;
      }

      async function deleteSessionById(sessionId) {
        if (!sessionId) {
          showError({ title: 'No session selected', recovery: 'Pick a session first', code: 'NO_SESSION' });
          return;
        }
        const confirmed = confirm(`Delete session "${getSessionDisplayName(sessionId)}" and all messages?`);
        if (!confirmed) {
          return;
        }
        updateSystemStatus('warning', 'Deleting session‚Ä¶');
        try {
          const response = await fetch(`/sessions/${sessionId}`, { method: 'DELETE' });
          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            showError({ title: data.message || 'Failed to delete session', recovery: data.recovery || 'Try again', code: data.code });
            return;
          }
          if (current === sessionId) {
            current = null;
            chat.innerHTML = '';
            stats.textContent = '';
            sessionNameInput.value = '';
          }
          await listSessions();
          if (current) {
            await loadSelected();
          }
          updateSystemStatus('connected', 'Session deleted');
        } catch (e) {
          console.error('delete session failed', e);
          showError({ title: 'Delete failed', recovery: 'Check connection and retry', code: 'DELETE_SESSION_ERROR' });
        }
      }

      async function copySessionId(sessionId, trigger) {
        const original = trigger.textContent;
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(sessionId);
          } else {
            const ta = document.createElement('textarea');
            ta.value = sessionId;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
          trigger.textContent = '‚úì';
        } catch (e) {
          console.error('Copy failed', e);
          trigger.textContent = '‚úï';
        } finally {
          setTimeout(() => {
            trigger.textContent = original;
          }, 1200);
        }
      }

      newBtn.addEventListener('click', createNew);

      refreshSessionsBtn.addEventListener('click', async () => {
        await listSessions();
      });

      refreshBtn.addEventListener('click', async () => {
        await listSessions({ suppressErrors: true });
        await loadSelected();
      });

      saveNameBtn.addEventListener('click', async () => {
        if (!current) {
          showError({ title: 'No session selected', recovery: 'Select a session first', code: 'NO_SESSION' });
          return;
        }
        const desiredName = sessionNameInput.value.trim();
        try {
          updateSystemStatus('warning', 'Saving name‚Ä¶');
          const response = await fetch(`/sessions/${current}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ display_name: desiredName })
          });
          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            showError({ title: data.message || 'Failed to save name', recovery: data.recovery || 'Try again', code: data.code });
            return;
          }
          await listSessions();
          isEditingName = false;
          sessionNameInput.value = data.session?.display_name || desiredName;
          updateSystemStatus('connected', 'Name saved');
        } catch (e) {
          console.error('save name failed', e);
          showError({ title: 'Could not save name', recovery: 'Check connection and retry', code: 'SAVE_NAME_ERROR' });
        }
      });

      sessionNameInput.addEventListener('focus', () => {
        isEditingName = true;
      });

      sessionNameInput.addEventListener('blur', () => {
        setTimeout(() => { isEditingName = false; }, 0);
      });

      limitRange.addEventListener('input', () => {
        viewLimit = parseInt(limitRange.value, 10) || 100;
        limitLabel.textContent = String(viewLimit);
      });

      limitRange.addEventListener('change', () => {
        loadSelected();
      });

      async function sendMessage() {
        if (!current) {
          await createNew();
        }
        if (!current) {
          return;
        }
        const fromId = document.getElementById('fromId').value.trim() || 'brent';
        const box = document.getElementById('msgBox');
        const auto = document.getElementById('autoReply').checked;
        const text = box.value.trim();
        if (!text) return;
        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.textContent = 'Sending‚Ä¶';
        const addedLoading = auto ? addLoadingMessage() : null;
        updateSystemStatus('warning', 'Sending message‚Ä¶');
        try {
          if (auto) {
            const response = await fetch('/chat-with-codex', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-AI-Id': fromId },
              body: JSON.stringify({ message: text, session_id: current })
            });
            const data = await response.json().catch(() => ({}));
            removeLoadingMessage();
            if (!response.ok) {
              showError({ title: data.message || 'Request failed', recovery: data.recovery || 'Try again in a bit', code: data.code });
              addMessage('System', data.message || 'Codex could not process that request.', 'error');
            } else {
              await loadSelected();
              updateSystemStatus('connected', 'Connected');
            }
          } else {
            const response = await fetch(`/sessions/${current}/messages`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ from: 'user', content: text, ai_id: fromId })
            });
            if (!response.ok) {
              const data = await response.json().catch(() => ({}));
              showError({ title: data.message || 'Failed to add message', recovery: data.recovery || 'Please try again', code: data.code });
            }
            await loadSelected();
            updateSystemStatus('connected', 'Connected');
          }
          box.value = '';
        } catch (e) {
          console.error('sendMessage failed', e);
          removeLoadingMessage();
          showError({ title: 'Connection failed', recovery: 'Check your connection and retry', code: 'NETWORK_ERROR' });
          addMessage('System', 'Connection error - please try again', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Send';
          if (addedLoading) {
            removeLoadingMessage();
          }
        }
      }

      document.getElementById('sendBtn').addEventListener('click', sendMessage);

      document.getElementById('msgBox').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      chat.addEventListener('scroll', () => {
        isAtBottom = shouldAutoScroll();
      });

      async function checkSystemHealth() {
        try {
          const response = await fetch('/healthz');
          if (response.ok) {
            updateSystemStatus('connected', 'Connected');
          } else {
            updateSystemStatus('warning', 'Service issues');
          }
        } catch (e) {
          updateSystemStatus('error', 'Connection lost');
        }
      }

      toggleSidebarBtn?.addEventListener('click', () => {
        document.body.classList.toggle('sidebar-hidden');
      });

      closeSidebarBtn?.addEventListener('click', () => {
        document.body.classList.add('sidebar-hidden');
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth >= 900) {
          document.body.classList.remove('sidebar-hidden');
        }
      });

      if (window.innerWidth < 900) {
        document.body.classList.add('sidebar-hidden');
      }

      (async () => {
        updateSystemStatus('warning', 'Loading sessions‚Ä¶');
        const listed = await listSessions();
        if (listed && current) {
          await loadSelected();
        }
        timer = setInterval(loadSelected, 3000);
        setInterval(checkSystemHealth, 30000);
        await checkSystemHealth();
        updateSystemStatus('connected', 'Connected');
      })();
    </script>
  </body>
</html>
